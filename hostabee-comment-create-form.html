<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../hostabee-profile-picture/hostabee-profile-picture.html">

<dom-module id="hostabee-comment-create-form" theme-for="vaadin-text-area">
  <template>
    <style>
      :host {
        @apply --layout-flex;
      }

      vaadin-text-area {
        width: 100%;
        max-height: 38px;
      }

      vaadin-text-area[has-value] {
        min-height: 76px;
        max-height: 150px;
      }

      vaadin-text-area[focused][has-value] {
        min-height: 76px;
      }

      [part="input-field"] {
        min-height: 38px;
      }

      [part="value"] {
        min-height: 24px;
      }

      .actions {
        @apply --layout-horizontal;
        @apply --layout-end-justified;
      }

      .actions vaadin-button {
        margin-left: 8px;
      }

      .horizontal {
        @apply --layout-horizontal;
      }

      hostabee-profile-picture {
        margin: 4px;
      }
    </style>

    <div class="horizontal">
      <template is="dom-if" if="[[author]]">
        <hostabee-profile-picture src="[[author]]" size="38"></hostabee-profile-picture>
      </template>
      <vaadin-text-area placeholder="Write a comment..." minlength="20" error-message="At least 20 chars" onkeydown="[[_handleKeyDown()]]" value="{{value}}" required></vaadin-text-area>
    </div>

    <template is="dom-if" if="[[actionButtonsVisible]]">
      <div class="actions">
        <vaadin-button theme="small" on-click="cancel">Cancel</vaadin-button>
        <vaadin-button theme="primary small" on-click="confirm">Save</vaadin-button>
      </div>
    </template>

  </template>

  <script>
    /**
     * `hostabee-comment-create-form`
     * 
     * A form to create a comment.
     *
     * @summary A form to create a comment.
     * @customElement
     * @polymer
     * @extends {Polymer.Element}
     * @demo demo/hostabee-comment-create-form/basic.html Basic
     */
    class HostabeeCommentCreateForm extends Polymer.Element {

      static get is() {
        return 'hostabee-comment-create-form';
      }

      static get properties() {
        return {
          /**
           * Buttons are shown. Set to `true` to display buttons to the bottom
           * of the form.
           * 
           * @type {Boolean}
           * @default false
           */
          buttonsShown: {
            type: Boolean,
            value: false,
          },
          /**
           * Buttons are shown when form input is not empty. Set to `true` to
           * display buttons to the bottom of the form if and only if the input
           * is not empty.
           * 
           * @type {Boolean}
           * @default false
           */
          buttonsShownIfValue: {
            type: Boolean,
            value: false,
          },
          /**
           * Author of the comments sent by the form.
           * 
           * @type {Object}
           */
          author: {
            type: Object,
          },
          /**
           * Buttons are visible. In contrary of the both options "buttonsShown"
           * and "buttonsShownIfValue" which are user wishes, this property tells
           * the actual state about the buttons visibility. It's the result of
           * the consideration of the options and the current form input value.
           * 
           * @type {Boolean}
           * @default false
           */
          actionButtonsVisible: {
            type: Boolean,
            value: false,
            readOnly: true,
          },
          /**
           * Value in the form input.
           * 
           * @type {String}
           */
          value: {
            type: String,
          },
        };
      }

      /**
       * Array of strings describing multi-property observer methods and their
       * dependant properties
       */
      static get observers() {
        return [
          '_actionButtonsVisibilityChanged(value)',
          '_actionButtonsVisibilityChanged(buttonsShown)',
        ];
      }

      /**
       * Cancels the form and cleans it.
       */
      cancel() {
        let textArea = this.shadowRoot.querySelector('vaadin-text-area');
        textArea.blur();
        textArea.value = '';
        textArea.invalid = false;
      }

      /**
       * Confirms the form and cleans it.
       */
      confirm() {
        let textArea = this.shadowRoot.querySelector('vaadin-text-area');
        if (textArea.validate()) {
          this.dispatchEvent(new CustomEvent('comment-added', {
            bubbles: true,
            composed: true,
            detail: Object.assign({}, {
              content: textArea.value.trim(),
              created: Date.now(),
            }, this.author ? {
              author: this.author,
            } : null)
          }));
          this.cancel();
        }
      }

      /**
       * Handles `keydown` events.
       * 
       * On "Escape" cancels the form.
       * On "Enter" confirms the form.
       * 
       * @private
       */
      _handleKeyDown() {
        return (event) => {
          if (event.key == 'Escape') {
            event.preventDefault();
            this.cancel();
          } else if (event.key == 'Enter') {
            event.preventDefault();
            this.confirm();
          }
        };
      }

      /**
       * Defines if action buttons must be visible or not. It depends of the
       * choice of the user and the form state.
       * 
       * @private
       */
      _actionButtonsVisibilityChanged() {
        this._setActionButtonsVisible(this.buttonsShown ||
          this.buttonsShownIfValue && this.value.length > 0);
      }

      /**
       * Fired when the form is confirmed.
       * _(bubbles: true, composed: true)_
       * 
       * @event comment-added
       * @param {Object} detail The comment to add.
       */

    }

    window.customElements.define(HostabeeCommentCreateForm.is, HostabeeCommentCreateForm);
  </script>
</dom-module>
