<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="./hostabee-comment.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="./hostabee-comment-create-form.html">

<dom-module id="hostabee-comment-flow">
  <template>
    <style>
      :host {
        height: 100%;
        @apply --layout-vertical;
      }

      .comments-container {
        overflow-y: scroll;
        padding-bottom: 10px;
      }
    </style>
    <div class="comments-container">
      <template is="dom-repeat" items="[[_comments]]" as="comment" restamp>
        <hostabee-comment item="[[comment]]" read-only=[[readOnly]]></hostabee-comment>
      </template>
    </div>
    <template is="dom-if" if="[[!readOnly]]" restamp>
      <slot id="form" name="form">
        <hostabee-comment-create-form author="[[author]]"></hostabee-comment-create-form>
      </slot>
    </template>
  </template>
  <script>
    /**
     * `hostabee-comment-flow`
     * 
     * Commenting solution out-of-the-box in a Web Component. Provides in few
     * lines of code a comments flow allowing users to create, edit and delete
     * comments.
     *
     * @summary Commenting solution out-of-the-box.
     * @customElement
     * @polymer
     * @extends {Polymer.Element}
     * @demo demo/hostabee-comment-flow/basic.html Basic
     * @demo demo/hostabee-comment-flow/read-only.html Read only
     */
    class HostabeeCommentFlow extends Polymer.Element {

      static get is() {
        return 'hostabee-comment-flow';
      }

      static get properties() {
        return {
          /**
           * Comments to display.
           * 
           * Expected model of `item`:
           * {
           *    content: 'Cum sociis natoque penatibus et magnis.',
           *    created: 1548016737000,
           *    author: {
           *      fullname: 'John Doe',
           *      profilePictureURL: ''
           *    }
           * }
           * 
           * The `item.author`, `item.author.profilePictureURL` properties are
           * optional. The `author.fullname` property can be substitute by
           * `author.name`.
           * 
           * The `author` property of a comment can also be a number/string
           * (the user ID) if you have provided the list of user.
           * 
           * @type {Array}
           * @default []
           */
          comments: {
            type: Array,
            value: [],
          },
          /**
           * The content of the slot "form". It can returns `null` if the element
           * is not yet ready and the shadowRoot is not initialized. If no element
           * is provided for the slot "form", a `hostabee-comment-create-form"
           * element is automatically inserted. In the other wise, you have the
           * responsibility of you form validation and submission.
           * 
           * @type {Object}
           */
          form: {
            type: Object,
            readOnly: true,
            notify: true,
          },
          /**
           * List of users. It is OPTIONAL and will be used to retrieve comment
           * author when the comment objects contain only author ID. It can be
           * required for more some features.
           * 
           * Expected model of `user`:
           * {
           *    fullname: 'John Doe',
           *    profilePictureURL: ''
           * }
           * 
           * The `profilePictureURL` property is optional. The `fullname`
           * property can be substitute by `name`.
           * 
           * @type {Array}
           * @default []
           */
          users: {
            type: Array,
            value: [],
          },
          /**
           * Turns the read only mode on. Comments are not editable even by their
           * author.
           * 
           * @type {Boolean}
           * @default false
           */
          readOnly: {
            type: Boolean,
            value: false,
          },
          /**
           * A user. The comment flow will adjust the view according to the
           * provided user representation. For exemple, if the flow is not in
           * read only mode, the user will be able to edit/delete only comments
           * that they have wrote. And all comments sent through the form will
           * contain information about the author.
           * 
           * @type {Object}
           */
          author: {
            type: Object,
          },
          /**
           * Computed list of comment. The data transformtion ensures the good
           * internal functioning.
           * 
           * @type {Array}
           */
          _comments: {
            type: Array,
            readOnly: true,
          },
          /**
           * Observes nodes changes.
           * 
           * @type {Object}
           */
          __nodesObserver: Object,
        };
      }

      static get observers() {
        return [
          '_computeComments(comments.*)',
          '_computeComments(users.*)',
        ];
      }

      /**
       * Called every time the element is inserted into the DOM. Useful for 
       * running setup code, such as fetching resources or rendering.
       * Generally, you should try to delay work until this time.
       */
      connectedCallback() {
        super.connectedCallback();
        Polymer.RenderStatus.afterNextRender(this, function() {
          this._setForm(this._firstAssignedElement('#form'));
        });
        this.__nodesObserver = new Polymer.FlattenedNodesObserver(this, (info) => {
          this._setForm(this._firstAssignedElement('#form'));
        });
      }

      /**
       * Called every time the element is removed from the DOM. Useful for 
       * running clean up code (removing event listeners, etc.).
       */
      disconnectedCallback() {
        super.disconnectedCallback();
        this.__nodesObserver.disconnect();
      }

      /**
       * Gets the first slotted element of the element target by CSS selector.
       * It can returns `null` if the element is not found or if its shadowRoot
       * is not opened.
       * 
       * @private
       * @param {String} selector The CSS selector to be used to find the element
       * to get the first slotted element.
       * @return {Object} The first slotted element of the target one.
       */
      _firstAssignedElement(selector) {
        var elem = this.shadowRoot ? this.shadowRoot.querySelector(selector) : null;
        if (!elem) {
          return null;
        }
        let assignedElems = elem.assignedElements ? elem.assignedElements({
          flatten: true
        }) : elem.assignedNodes({
          flatten: true
        }).filter((n) => n instanceof HTMLElement);
        return assignedElems.length > 0 ? assignedElems[0] : null;
      }

      /**
       * Fills list of comment with authors when the comment contains only an ID
       * and a list of users is provided.
       * 
       * @private
       */
      _computeComments() {
        if (!this.users) {
          this._set_comments(this.comments);
          return;
        }
        this._set_comments(this.comments.map((comment) => {
          if (typeof comment.author != 'object') {
            var user = this.users.find((u) => u.id == comment.author);
            if (user) {
              comment.author = user;
            }
          }
          return comment;
        }));
      }

    }

    window.customElements.define(HostabeeCommentFlow.is, HostabeeCommentFlow);
  </script>
</dom-module>
