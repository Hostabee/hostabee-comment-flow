<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="./hostabee-comment.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="./hostabee-comment-create-form.html">

<dom-module id="hostabee-comment-flow">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <template is="dom-repeat" items="[[_comments]]" as="comment" restamp>
      <hostabee-comment item="[[comment]]" read-only=[[readOnly]]></hostabee-comment>
    </template>
    <template is="dom-if" if="[[!readOnly]]">
      <slot id="form" name="form">
        <hostabee-comment-create-form author="[[author]]"></hostabee-comment-create-form>
      </slot>
    </template>
  </template>
  <script>
    /**
     * `hostabee-comment-flow`
     * 
     * Commenting solution out-of-the-box in a Web Component. Provides in few
     * lines of code a comments flow allowing users to create, edit and delete
     * comments.
     *
     * @summary Commenting solution out-of-the-box.
     * @customElement
     * @polymer
     * @extends {Polymer.Element}
     * @demo demo/hostabee-comment-flow/basic.html Basic
     * @demo demo/hostabee-comment-flow/read-only.html Read only
     */
    class HostabeeCommentFlow extends Polymer.Element {

      static get is() {
        return 'hostabee-comment-flow';
      }

      static get properties() {
        return {
          /**
           * Comments to display.
           * 
           * Expected model of `item`:
           * {
           *    content: 'Cum sociis natoque penatibus et magnis.',
           *    created: 1548016737000,
           *    author: {
           *      fullname: 'John Doe',
           *      profilePictureURL: ''
           *    }
           * }
           * 
           * The `item.author`, `item.author.profilePictureURL` properties are
           * optional. The `author.fullname` property can be substitute by
           * `author.name`.
           * 
           * The `author` property of a comment can also be a number/string
           * (the user ID) if you have provided the list of user.
           * 
           * @type {Array}
           * @default []
           */
          comments: {
            type: Array,
            value: [],
          },
          /**
           * List of users. It is OPTIONAL and will be used to retrieve comment
           * author when the comment objects contain only author ID. It can be
           * required for more some features.
           * 
           * Expected model of `user`:
           * {
           *    fullname: 'John Doe',
           *    profilePictureURL: ''
           * }
           * 
           * The `profilePictureURL` property is optional. The `fullname`
           * property can be substitute by `name`.
           * 
           * @type {Array}
           * @default []
           */
          users: {
            type: Array,
            value: [],
          },
          /**
           * Turns the read only mode on. Comments are not editable even by their
           * author.
           * 
           * @type {Boolean}
           * @default false
           */
          readOnly: {
            type: Boolean,
            value: false,
          },
          /**
           * A user. The comment flow will adjust the view according to the
           * provided user representation. For exemple, if the flow is not in
           * read only mode, the user will be able to edit/delete only comments
           * that they have wrote. And all comments sent through the form will
           * contain information about the author.
           * 
           * @type {Object}
           */
          author: {
            type: Object,
          },
          /**
           * Computed list of comment. The data transformtion ensures the good
           * internal functioning.
           * 
           * @type {Array}
           */
          _comments: {
            type: Array,
            readOnly: true,
          },
        };
      }

      static get observers() {
        return [
          '_computeComments(comments.*)',
          '_computeComments(users.*)',
        ];
      }

      /**
       * Gets the content of the slot "form". It can returns `null` if the element
       * is not yet ready and the shadowRoot is not initialized. In this case try
       * to call the function after a delay of 10ms and after it's been attached
       * to the DOM.
       * 
       * If no element is provided for the slot "form", a `hostabee-comment-create-form"
       * element is automatically inserted. In the other wise, you have the
       * responsibility of you form validation and submission.
       * 
       * @return {Object} The content of the slot "form".
       */
      form() {
        var form = this.shadowRoot ? this.shadowRoot.querySelector('#form') : null;
        return form ? form.assignedElements({
          flatten: true
        })[0] : null;
      }

      /**
       * Fills list of comment with authors when the comment contains only an ID
       * and a list of users is provided.
       * 
       * @private
       */
      _computeComments() {
        if (!this.users) {
          this._set_comments(this.comments);
          return;
        }
        this._set_comments(this.comments.map((comment) => {
          if (typeof comment.author != 'object') {
            var user = this.users.find((u) => u.id == comment.author);
            if (user) {
              comment.author = user;
            }
          }
          return comment;
        }));
      }

    }

    window.customElements.define(HostabeeCommentFlow.is, HostabeeCommentFlow);
  </script>
</dom-module>
