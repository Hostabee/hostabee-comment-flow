<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>hostabee-comment-flow test</title>

  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../hostabee-comment-flow.html">
</head>

<body>

  <test-fixture id="BasicTestFixture">
    <template>
      <hostabee-comment-flow></hostabee-comment-flow>
    </template>
  </test-fixture>

  <test-fixture id="ReadOnlyTestFixture">
    <template>
      <hostabee-comment-flow read-only></hostabee-comment-flow>
    </template>
  </test-fixture>

  <test-fixture id="CustomFormTestFixture">
    <template>
      <hostabee-comment-flow>
        <div class="custom-form" slot="form">MY FORM</div>
      </hostabee-comment-flow>
    </template>
  </test-fixture>

  <script>
    describe('Basic', function() {
      let element;

      beforeEach(function() {
        element = fixture('BasicTestFixture');
      });

      it('should be instantiable with default properties', function() {
        expect(element.comments).to.be.empty;
        expect(element.users).to.be.empty;
        expect(element.readOnly).to.be.false;
      });

      it('should link comments and authors when they are provided separately', function() {
        element.comments = [{
          author: 1,
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
          created: Date.now()
        }, {
          author: 'two',
          content: 'Lorem ipsum dolor sit amet.',
          created: Date.now()
        }, {
          author: 3,
          content: 'Consectetur adipiscing elit.',
          created: Date.now()
        }, {
          content: 'Consectetur adipiscing elit.',
          created: Date.now()
        }];
        element.users = [{
          id: 'two',
          name: 'Mary Jane'
        }, {
          id: 1,
          fullname: 'Peter Parker'
        }];
        expect(element._comments[0].author).to.be.equal(element.users[1]);
        expect(element._comments[1].author).to.be.equal(element.users[0]);
        expect(element._comments[2].author).to.be.equal(3);
        expect(element._comments[3].author).to.be.undefined;
      });

      it('should display form to add comments', function(done) {
        flush(function() {
          const form = element.shadowRoot.querySelector('hostabee-comment-create-form');
          expect(form).to.not.be.null;
          done();
        });
      });

      it('should insert author information in dispatched event when they have been provided', function(done) {
        element.author = {
          id: 42,
          fullname: 'John Doe',
        };
        const asyncAssert = function(event) {
          expect(event.detail.author).to.be.equal(element.author);
          element.removeEventListener('comment-added', asyncAssert);
          done();
        };
        element.addEventListener('comment-added', asyncAssert);
        flush(function() {
          const form = element.shadowRoot.querySelector('hostabee-comment-create-form');
          form.shadowRoot.querySelector('vaadin-text-area').value = 'Lorem ipsum dolor sit amet.';
          form.confirm();
        });
      });

      it('should contains a hostabee-comment-create-form by default', function(done) {
        const asyncAssert = function() {
          expect(element.form).to.be.an.instanceof(HostabeeCommentCreateForm);
          element.removeEventListener('form-changed', asyncAssert);
          done();
        };
        element.addEventListener('form-changed', asyncAssert);
      });
    });

    describe('ReadOnly', function() {
      let element;

      beforeEach(function() {
        element = fixture('ReadOnlyTestFixture');
      });

      it('should disable edit on all comments', function(done) {
        element.comments = [{
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
          created: Date.now()
        }, {
          content: 'Lorem ipsum dolor sit amet.',
          created: Date.now()
        }, {
          content: 'Consectetur adipiscing elit.',
          created: Date.now()
        }, {
          content: 'Consectetur adipiscing elit.',
          created: Date.now()
        }];
        flush(function() {
          element.shadowRoot.querySelectorAll('hostabee-comment')
            .forEach(comment => expect(comment.readOnly).to.be.true);
          done();
        });
      });

      it('should not display form to add comments', function(done) {
        const asyncAssert = function() {
          expect(element.form).to.be.null;
          expect(element.shadowRoot.querySelector('#form')).to.be.null;
          element.removeEventListener('form-changed', asyncAssert);
          done();
        };
        element.addEventListener('form-changed', asyncAssert);
      });
    });

    describe('CustomForm', function() {
      let element;

      beforeEach(function() {
        element = fixture('CustomFormTestFixture');
      });

      it('should display the custom form', function(done) {
        flush(function() {
          expect(element.form.tagName).to.be.equal('DIV');
          expect(element.form.innerText).to.be.equal('MY FORM');
          done();
        });
      });

      it('should not display the custom form when read only mode is turned on', function(done) {
        element.readOnly = true;
        flush(function() {
          expect(element.form).to.be.null;
          expect(element.shadowRoot.querySelector('#form')).to.be.null;
          done();
        });
      });
    });
  </script>

</body>

</html>
