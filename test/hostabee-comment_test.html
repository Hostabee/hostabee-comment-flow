<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>hostabee-comment test</title>

  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../hostabee-comment.html">
</head>

<body>

  <test-fixture id="BasicTestFixture">
    <template>
      <hostabee-comment></hostabee-comment>
    </template>
  </test-fixture>

  <test-fixture id="ReadOnlyTestFixture">
    <template>
      <hostabee-comment read-only></hostabee-comment>
    </template>
  </test-fixture>

  <script>
    describe('Basic', function() {
      let element;

      before(function() {
        element = fixture('BasicTestFixture');
      });

      it('should be instantiable with default properties', function() {
        expect(element.item).to.be.undefined;
        expect(element.readOnly).to.be.false;
      });

      it('should not be able to confirm edit when not in edit mode', function(done) {
        const asyncAssert = function() {
          expect.fail('event should not have been dispatched');
        };
        element.addEventListener('comment-modified', asyncAssert);
        element.confirmEdit();
        setTimeout(function() {
          element.removeEventListener('comment-modified', asyncAssert);
          done();
        }, 10);
      });

      it('should set current comment content to text area when switching in edit mode', function(done) {
        const comment = {
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
          created: Date.now(),
        };
        element.item = comment;
        element.edit();
        flush(function() {
          var textArea = element.shadowRoot.querySelector('vaadin-text-area');
          expect(textArea).to.not.be.null;
          expect(textArea.value).to.be.equal(comment.content);
          done();
        });
      });

      it('should discard changes when edit is canceled', function(done) {
        const comment = {
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
          created: Date.now(),
        };
        element.item = comment;
        element.edit();
        flush(function() {
          var textArea = element.shadowRoot.querySelector('vaadin-text-area');
          expect(textArea).to.not.be.null;
          textArea.value = 'Curabitur vehicula dignissim dui.';
          element.cancelEdit();
          expect(textArea.value).to.be.equal(comment.content);
          done();
        });
      });

      it('should cut displayed text if too long and display "read more" button', function(done) {
        const comment = {
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.' +
            'Donec vel mauris tristique, aliquet ligula ac, pulvinar ex. Ut a urna' +
            'sit amet velit pretium consectetur. Lorem ipsum dolor sit amet,' +
            'consectetur adipiscing elit.',
          created: Date.now(),
        };
        element.item = comment;
        expect(comment.content.length).to.be.greaterThan(element.maxLengthBeforeCollapse);
        expect(element.opened).to.be.false;
        flush(function() {
          let content = element.shadowRoot.querySelector('.content');
          expect(content.querySelector('span').innerText).to.be.equal('Lorem ipsum ' +
            'dolor sit amet, consectetur adipiscing elit.Donec vel mauris tristique, ' +
            'aliquet ligula ac, pulvinar ex. Ut a urnasit amet velit pretium co...');
          expect(content.querySelector('iron-collapse').opened).to.be.false;
          expect(content.querySelector('vaadin-button').innerText.trim()).to.be.equal('read more');
          done();
        });
      });

      it('should display "show less" button when long comment is opened', function(done) {
        const comment = {
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.' +
            'Donec vel mauris tristique, aliquet ligula ac, pulvinar ex. Ut a urna' +
            'sit amet velit pretium consectetur. Lorem ipsum dolor sit amet,' +
            'consectetur adipiscing elit.',
          created: Date.now(),
        };
        element.item = comment;
        expect(comment.content.length).to.be.greaterThan(element.maxLengthBeforeCollapse);
        element.toggle();
        expect(element.opened).to.be.true;
        flush(function() {
          let content = element.shadowRoot.querySelector('.content');
          expect(content.querySelector('span').hidden).to.be.true;
          let collapse = content.querySelector('iron-collapse');
          expect(collapse.opened).to.be.true;
          expect(collapse.firstElementChild.innerText).to.be.equal(comment.content);
          expect(content.querySelector('vaadin-button').innerText.trim()).to.be.equal('show less');
          done();
        });
      });

      it('should not display "read more" button when comment is short', function(done) {
        const comment = {
          content: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
          created: Date.now(),
        };
        element.item = comment;
        expect(comment.content.length).to.be.lessThan(element.maxLengthBeforeCollapse);
        expect(element.isShort).to.be.true;
        flush(function() {
          let content = element.shadowRoot.querySelector('.content');
          let span = content.querySelector('span');
          expect(span.hidden).to.be.false;
          expect(span.innerText).to.be.equal(comment.content);
          expect(content.querySelector('iron-collapse').opened).to.be.false;
          expect(content.querySelector('vaadin-button').hidden).to.be.true;
          done();
        });
      });
    });

    describe('ReadOnly', function() {
      let element;

      before(function() {
        element = fixture('ReadOnlyTestFixture');
      });

      it('should be instantiable with default properties', function() {
        expect(element.item).to.be.undefined;
        expect(element.readOnly).to.be.true;
      });

      it('should not display the menu button', function() {
        var menu = element.shadowRoot.querySelector('paper-menu-button');
        expect(menu).to.not.be.null;
        expect(menu.querySelector('paper-icon-button').hidden).to.be.true;
      });

      it('should disable method delete', function(done) {
        const asyncAssert = function() {
          expect.fail('event should not have been dispatched');
        };
        element.addEventListener('comment-deleted', asyncAssert);
        element.delete();
        setTimeout(function() {
          element.removeEventListener('comment-deleted', asyncAssert);
          done();
        }, 10);
      });

      it('should disable method edit', function() {
        element.edit();
        expect(element.editing).to.be.false;
      });
    });
  </script>

</body>

</html>
